
name: Main merge policy (hotfix/release only)

on:
  pull_request:
    branches: [ main ]         # Ejecuta en PRs hacia main
    types: [ opened, synchronize, reopened, ready_for_review ]
  workflow_call:               # Lo mantienes reusable si otros repos quieren invocarlo

jobs:
  validate-source-branch:
    runs-on: ubuntu-latest
    # Evita que se ejecute en PRs del propio repo "org-policies" (host), si no deseas verlo allí
    if: ${{ github.repository != 'ASTAY-SYSTEMS/org-policies' }}
    steps:
      - name: Validate that PR source is hotfix/ or release/
        run: |
          # Validar solo si la PR apunta al target_branch (cuando se invoca como reusable pasas 'target_branch')
          # si el workflow fue invocado como reusable: inputs.target_branch. TARGET debe ser igual a main 
          TARGET="${{ inputs.target_branch || 'main' }}"
          # github.event.pull_request.base.ref: Indica a que rama destino apunta el pull request. (debe ser main) 
          if [ "$TARGET" != "${{ github.event.pull_request.base.ref }}" ]; then
            echo "Skipping: base is ${{ github.event.pull_request.base.ref }}; target is $TARGET"
            # si no es main entonces simplemente lo deja pasar, no arroja error.
            exit 0
          fi
          SRC="${{ github.head_ref }}"
          echo "Source: $SRC → Base: ${{ github.event.pull_request.base.ref }}"
          if [[ ! "$SRC" =~ ^(hotfix/|release/) ]]; then
            echo "❌ source branch must start with 'hotfix/' or 'release/'"
            exit 1
          fi
