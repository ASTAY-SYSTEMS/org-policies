name: "K6 - Performance Test with K6"
description: "Ejecuta pruebas de rendimiento con K6"
inputs:
  config_path:
    description: "ruta del archivo config.json con los scripts k6"
    required: true
    default: "tests/k6/config.json"
  directory_path:
    description: "Carpeta donde estan los scripts para K6"
    required: true
  directory_core_path:
    description: "Carpeta donde esta el core de K6"
    required: true 
  base_url:
    description: "Base URL del API"
    required: true
  k6_image:
    description: "Imagen Docker de k6"
    required: false
    default: "grafana/k6:0.49.0"
  summary_export:
    description: "Exportar resumen k6 (true | false)"
    required: false
    default: "false"
runs:
  using: "composite"
  steps:    
    - name: Install jq 
      shell: bash
      run: sudo apt-get install -y jq

    
    #- name: Inspect container volumes
    #  shell: bash
    #  run: |
    #    docker run --rm -i \
    #      --entrypoint sh \
    #      -v ${{ github.workspace }}/${{ inputs.directory_path }}:/scripts/${{ inputs.directory_path }} \
    #      -v ${{ github.workspace }}/${{ inputs.directory_core_path }}:/k6-core \
    #      -v ${{ github.workspace }}/k6-results:/results \
    #      ${{ inputs.k6_image }} \
    #      -lc "echo 'ðŸ“‚ /scripts:' && ls -R /scripts && \
    #          echo 'ðŸ“‚ /k6-core:' && ls -R /k6-core && \
    #          echo 'ðŸ“‚ /results:' && ls -R /results"

    #chmod 777 "${{ github.workspace }}/k6-results" || true        
    #set -e
    - name: Run k6 scripts from config.json 
      shell: bash
      run: |
        
        mkdir -p ${{ github.workspace }}/k6-results        
        
        for row in $(jq -c '.modules[]' ${{ inputs.config_path }}); do 
          name=$(echo $row | jq -r '.name') 
          scripts=$(echo $row | jq -r '.scripts[]') 
          envs=$(echo $row | jq -r '.envs[]') 
          i=0 
          for script in $scripts; do 
            env_line=$(echo $row | jq -r ".envs[$i]") 
            EXTRA_ENVS="" 
            DASHBOARD_ENVS=""
            SUMMARY_FLAG=""

            if [ "${{ inputs.summary_export }}" = "true" ]; then 
              SUMMARY_FLAG="--summary-export=/results/$name-$(basename $script).json" 
              DASHBOARD_ENVS="-e K6_WEB_DASHBOARD=true \
                              -e K6_WEB_DASHBOARD_EXPORT=/results/$name-$(basename $script).html \
                              -e K6_WEB_DASHBOARD_PERIOD=10s \
                              -e K6_WEB_DASHBOARD_PORT=-1" 
            fi
            if [ -n "$env_line" ] && [ "$env_line" != "null" ]; then 
              IFS=';' read -ra ENV_PAIRS <<< "$env_line" 
              for pair in "${ENV_PAIRS[@]}"; do 
                pair_trim="$(echo "$pair" | xargs)" 
                if [ -n "$pair_trim" ]; then 
                  EXTRA_ENVS="$EXTRA_ENVS -e $pair_trim" 
                fi 
              done 
            fi 
            echo "â–¶ Ejecutando mÃ³dulo $name script $script con envs: $env_line"

            docker run --rm -i \
              --user $(id -u):$(id -g) \
              -e BASE_URL=${{ inputs.base_url }} \
              $DASHBOARD_ENVS \
              $EXTRA_ENVS \
              -v ${{ github.workspace }}/${{ inputs.directory_path }}:/scripts/${{ inputs.directory_path }} \
              -v ${{ github.workspace }}/${{ inputs.directory_core_path }}:/k6-core \
              -v ${{ github.workspace }}/k6-results:/results \
              ${{ inputs.k6_image }} \
              run --exit-on-error=false /scripts/${{ inputs.directory_path }}/$script $SUMMARY_FLAG
            exit_code=$?
            if [ $exit_code -ne 0 ]; then
              echo "âš ï¸ El script $script fallÃ³ (cÃ³digo $exit_code), pero continuamos..."
            fi
            i=$((i+1)) 
          done 
        done
        
    - name: Upload k6 summary
      if: ${{ inputs.summary_export == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: k6-summary
        path: ${{ github.workspace }}/k6-results/