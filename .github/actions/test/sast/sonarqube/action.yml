name: "SAST - SonarQube (Docker Scanner)"
description: "Ejecuta análisis SAST con SonarQube usando sonar-scanner-cli en Docker"

inputs:
  sonar_host_url:
    description: "URL de SonarQube"
    required: true

  sonar_token:
    description: "Token de SonarQube"
    required: true

  project_key:
    description: "SonarQube project key"
    required: true

  project_name:
    description: "SonarQube project name"
    required: true

  project_base_dir:
    description: "Directorio base a analizar"
    required: false
    default: "."

  sonar_sources:
    description: "Rutas de código fuente"
    required: false
    default: "."

  sonar_extra_args:
    description: "Argumentos extra para sonar-scanner"
    required: false
    default: ""

  scanner_image:
    description: "Imagen de SonarScanner"
    required: false
    default: "sonarsource/sonar-scanner-cli:latest"

runs:
  using: "composite"
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Preparar directorios Sonar
      shell: bash
      run: |
        mkdir -p .sonar .scannerwork
        chmod -R 777 .sonar .scannerwork

    - name: Ejecutar SonarScanner (Docker)
      shell: bash
      working-directory: ${{ inputs.project_base_dir }}
      env:
        SONAR_HOST_URL: ${{ inputs.sonar_host_url }}
        SONAR_TOKEN: ${{ inputs.sonar_token }}
      run: |
        set -euo pipefail

        docker run --rm \
          -e SONAR_HOST_URL="$SONAR_HOST_URL" \
          -e SONAR_TOKEN="$SONAR_TOKEN" \
          -e SONAR_USER_HOME="/usr/src/.sonar" \
          -v "$PWD":/usr/src \
          -v "$PWD/.sonar":/usr/src/.sonar \
          -v "$PWD/.scannerwork":/usr/src/.scannerwork \
          "${{ inputs.scanner_image }}" \
          -Dsonar.projectKey="${{ inputs.project_key }}" \
          -Dsonar.projectName="${{ inputs.project_name }}" \
          -Dsonar.sources="${{ inputs.sonar_sources }}" \
          -Dsonar.projectBaseDir="/usr/src" \
          -Dsonar.qualitygate.wait=true \
          -Dsonar.qualitygate.timeout=300 \
          ${{ inputs.sonar_extra_args }}
