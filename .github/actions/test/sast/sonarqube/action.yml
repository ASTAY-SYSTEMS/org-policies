
name: "SAST - SonarQube (Docker Scanner)"
description: "Ejecuta análisis SAST con SonarQube usando sonarsource/sonar-scanner-cli en Docker"

inputs:
  sonar_host_url:
    description: "URL de SonarQube (ej. http://localhost:9000)"
    required: true
  sonar_token:
    description: "Token de SonarQube"
    required: true
  project_key:
    description: "SonarQube project key (único en la instancia)"
    required: true
  project_name:
    description: "SonarQube project name (descriptivo)"
    required: true
  project_base_dir:
    description: "Directorio base a analizar (montado en /usr/src)"
    required: false
    default: "."
  sonar_sources:
    description: "Ruta(s) de fuentes relativas a project_base_dir (ej. src)"
    required: false
    default: "."
  sonar_extra_args:
    description: "Argumentos extra para sonar-scanner (línea de comandos)"
    required: false
    default: ""
  scanner_image:
    description: "Imagen del SonarScanner CLI"
    required: false
    default: "sonarsource/sonar-scanner-cli:latest"

runs:
  using: "composite"
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    # (Opcional pero recomendado) Verificar que SonarQube responde
    - name: Ping SonarQube
      shell: bash
      env:
        SONAR_HOST_URL: ${{ inputs.sonar_host_url }}
      run: |
        set -euo pipefail
        echo "Verificando SonarQube en ${SONAR_HOST_URL}..."
        curl -sS -f "${SONAR_HOST_URL}/api/system/status" | tee sonar_status.json
        echo "STATUS:"
        cat sonar_status.json

    - name: Ejecutar SonarScanner en Docker
      shell: bash
      working-directory: ${{ inputs.project_base_dir }}
      env:
        SONAR_HOST_URL: ${{ inputs.sonar_host_url }}
        SONAR_TOKEN: ${{ inputs.sonar_token }}
      run: |
        set -euo pipefail

        echo "Ejecutando SonarScanner dentro del contenedor..."
        docker run --rm \
          -e SONAR_HOST_URL="${SONAR_HOST_URL}" \
          -e SONAR_TOKEN="${SONAR_TOKEN}" \
          -v "$PWD":/usr/src \
          "${{ inputs.scanner_image }}" \
          -Dsonar.projectKey="${{ inputs.project_key }}" \
          -Dsonar.projectName="${{ inputs.project_name }}" \
          -Dsonar.sources="${{ inputs.sonar_sources }}" \
          -Dsonar.projectBaseDir="/usr/src" \
          -Dsonar.working.directory="/usr/src/.scannerwork" \
          ${{ inputs.sonar_extra_args }}

        # Validar que se generó report-task.txt en el directorio donde se ejecutó el análisis
        if [ ! -f ".scannerwork/report-task.txt" ]; then
          echo "ERROR: No se generó .scannerwork/report-task.txt en $PWD"
          echo "Revisa:"
          echo " - URL/Token válidos (SONAR_HOST_URL / SONAR_TOKEN)"
          echo " - projectKey / projectName correctos"
          echo " - sonar.sources apunta a código existente"
          exit 1
        fi

        echo "Contenido de .scannerwork/report-task.txt:"
        cat ".scannerwork/report-task.txt" || true

        # Copiar el archivo a la raíz del workspace para que el Quality Gate lo encuentre
        mkdir -p "$GITHUB_WORKSPACE/.scannerwork"
        cp -f ".scannerwork/report-task.txt" "$GITHUB_WORKSPACE/.scannerwork/report-task.txt"

    - name: Quality Gate
      if: ${{ inputs.sonar_extra_args == '' }} # ejecuta siempre si no se sobreescribe el gating
      uses: sonarsource/sonarqube-quality-gate-action@v1.1.0
      env:
        SONAR_TOKEN: ${{ inputs.sonar_token }}
        SONAR_HOST_URL: ${{ inputs.sonar_host_url }}
