name: "SAST - SonarQube (Docker Scanner)"
description: "Ejecuta an√°lisis SAST con SonarQube usando sonarsource/sonar-scanner-cli en Docker"

inputs:
  sonar_host_url:
    description: "URL de SonarQube"
    required: true
  sonar_token:
    description: "Token de SonarQube"
    required: true
  project_key:
    description: "SonarQube project key"
    required: true
  project_name:
    description: "SonarQube project name"
    required: true
  project_base_dir:
    description: "Directorio base a analizar (montado en /usr/src)"
    required: false
    default: "."
  sonar_sources:
    description: "Ruta(s) de fuentes relativas a project_base_dir"
    required: false
    default: "."
  sonar_extra_args:
    description: "Argumentos extra para sonar-scanner"
    required: false
    default: ""
  scanner_image:
    description: "Imagen del SonarScanner CLI"
    required: false
    default: "sonarsource/sonar-scanner-cli:5.0.1"

runs:
  using: "composite"
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Ejecutar SonarScanner en Docker
      shell: bash
      working-directory: ${{ inputs.project_base_dir }}
      env:
        SONAR_HOST_URL: ${{ inputs.sonar_host_url }}
        SONAR_TOKEN: ${{ inputs.sonar_token }}
      run: |
        set -euo pipefail
        docker run --rm \
          -e SONAR_HOST_URL="$SONAR_HOST_URL" \
          -e SONAR_TOKEN="$SONAR_TOKEN" \
          -v "$PWD":/usr/src \
          "${{ inputs.scanner_image }}" \
          -Dsonar.projectKey="${{ inputs.project_key }}" \
          -Dsonar.projectName="${{ inputs.project_name }}" \
          -Dsonar.sources="${{ inputs.sonar_sources }}" \
          ${{ inputs.sonar_extra_args }}

    - name: Quality Gate
      if: ${{ inputs.sonar_extra_args == '' }} # ejecuta siempre si no sobreescribes gating
      uses: sonarsource/sonarqube-quality-gate-action@v1.1.0
      env:
        SONAR_TOKEN: ${{ inputs.sonar_token }}
        SONAR_HOST_URL: ${{ inputs.sonar_host_url }}