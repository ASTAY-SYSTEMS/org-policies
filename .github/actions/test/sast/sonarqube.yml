name: Reusable SAST - SonarQube
on:
  workflow_call:
    inputs:
      project_key:
        description: "SonarQube project key"
        type: string
        required: true

      project_name:
        description: "SonarQube project name"
        type: string
        required: true

      project_base_dir:
        description: "Base directory to analyze"
        type: string
        default: "."

      sonar_extra_args:
        description: "Extra SonarScanner arguments"
        type: string
        default: ""

      fail_on_quality_gate:
        description: "Fail pipeline if Quality Gate fails"
        type: boolean
        default: true

jobs:
  sast:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SonarScanner CLI
        run: |
          curl -sSLo sonar-scanner.zip \
            https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -q sonar-scanner.zip
          sudo mv sonar-scanner-*/ /opt/sonar-scanner
          echo "/opt/sonar-scanner/bin" >> $GITHUB_PATH

      - name: Run SonarQube SAST
        working-directory: ${{ inputs.project_base_dir }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          sonar-scanner \
            -Dsonar.projectKey=${{ inputs.project_key }} \
            -Dsonar.projectName="${{ inputs.project_name }}" \
            -Dsonar.sources=. \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.login=${SONAR_TOKEN} \
            ${{ inputs.sonar_extra_args }}

      - name: Quality Gate
        if: ${{ inputs.fail_on_quality_gate }}
        uses: sonarsource/sonarqube-quality-gate-action@v1.1.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
