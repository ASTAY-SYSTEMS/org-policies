name: "DAST - OWASP ZAP (Baseline/API)"
description: "Ejecuta DAST con OWASP ZAP usando zap-baseline.py o zap-api-scan.py via Docker"

inputs:
  mode:
    description: "baseline | api"
    required: false
    default: "baseline"
  target_url:
    description: "URL objetivo (baseline) o URL base del API"
    required: true
  zap_image:
    description: "Imagen Docker de ZAP"
    required: false
    default: "zaproxy/zap-stable"
  openapi_url:
    description: "URL del OpenAPI/Swagger (para mode=api)"
    required: false
    default: ""
  openapi_file:
    description: "Ruta local de OpenAPI (montada en /zap/wrk, para mode=api)"
    required: false
    default: ""
  rules_file:
    description: "Archivo .ini de reglas (-c)"
    required: false
    default: ""
  report_name:
    description: "Nombre base del reporte"
    required: false
    default: "zap-report"
  timeout_minutes:
    description: "Tiempo de espera (-m)"
    required: false
    default: "10"
  include_regex:
    description: "Patrón de inclusión (-i, baseline)"
    required: false
    default: ""
  exclude_regex:
    description: "Patrón de exclusión (-x)"
    required: false
    default: ""
  fail_on_warn:
    description: "Fallar en warn/med/high (-I)"
    required: false
    default: "true"
  additional_args:
    description: "Flags extra para los scripts"
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Preparar directorio de reportes
      shell: bash
      run: |
        set -e
        mkdir -p zap-reports
        chmod 777 zap-reports || true

    - name: Ejecutar ZAP (baseline/api)
      shell: bash
      run: |
        set -euo pipefail

        MODE="${{ inputs.mode }}"
        IMAGE="${{ inputs.zap_image }}"
        TARGET="${{ inputs.target_url }}"
        OPENAPI_URL="${{ inputs.openapi_url }}"
        OPENAPI_FILE="${{ inputs.openapi_file }}"
        RULES="${{ inputs.rules_file }}"
        REPORT="${{ inputs.report_name }}"
        TIMEOUT="${{ inputs.timeout_minutes }}"
        INCLUDE="${{ inputs.include_regex }}"
        EXCLUDE="${{ inputs.exclude_regex }}"
        FAIL_ON_WARN="${{ inputs.fail_on_warn }}"
        EXTRA="${{ inputs.additional_args }}"

        # Común: flags de fallo y reglas
        COMMON_ARGS=()
        if [ -n "$RULES" ]; then
          COMMON_ARGS+=(-c "/zap/wrk/$RULES")
        fi
        if [ "$FAIL_ON_WARN" = "true" ]; then
          COMMON_ARGS+=(-I)
        fi
        if [ -n "$EXTRA" ]; then
          # shellcheck disable=SC2086
          COMMON_ARGS+=($EXTRA)
        fi

        if [ "$MODE" = "api" ]; then
          # Preferir URL de OpenAPI; si no, usar archivo montado
          if [ -n "$OPENAPI_URL" ]; then
            API_TARGET="$OPENAPI_URL"
            FORMAT="openapi"
          elif [ -n "$OPENAPI_FILE" ]; then
            API_TARGET="/zap/wrk/$OPENAPI_FILE"
            FORMAT="openapi"
          else
            echo "ERROR: mode=api requiere openapi_url u openapi_file"
            exit 2
          fi

          docker run --rm --network host \
            -v "$PWD:/zap/wrk" \
            "$IMAGE" \
            zap-api-scan.py \
            -t "$API_TARGET" \
            -f "$FORMAT" \
            -m "$TIMEOUT" \
            -r "/zap/wrk/zap-reports/${REPORT}.html" \
            -J "/zap/wrk/zap-reports/${REPORT}.json" \
            -x "/zap/wrk/zap-reports/${REPORT}.xml" \
            "${COMMON_ARGS[@]}"

        else
          # baseline
          BASE_ARGS=()
          if [ -n "$INCLUDE" ]; then BASE_ARGS+=(-i "$INCLUDE"); fi
          if [ -n "$EXCLUDE" ]; then BASE_ARGS+=(-x "$EXCLUDE"); fi

          docker run --rm --network host \
            -v "$PWD:/zap/wrk" \
            "$IMAGE" \
            zap-baseline.py \
            -t "$TARGET" \
            -m "$TIMEOUT" \
            -r "/zap/wrk/zap-reports/${REPORT}.html" \
            -J "/zap/wrk/zap-reports/${REPORT}.json" \
            -x "/zap/wrk/zap-reports/${REPORT}.xml" \
            "${BASE_ARGS[@]}" \
            "${COMMON_ARGS[@]}"
        fi

    - name: Publicar reportes (artifact)
      uses: actions/upload-artifact@v4
      with:
        name: zap-dast-reports
        path: zap-reports